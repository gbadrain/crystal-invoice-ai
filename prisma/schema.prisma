// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum InvoiceStatus {
  draft
  pending
  paid
  overdue
  trashed
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  passwordHash         String
  createdAt            DateTime  @default(now())
  invoices             Invoice[] // Relation to Invoice model

  // Profile
  avatarUrl            String?   // base64 data URL or external URL

  // Settings
  name                 String?   // display name (shown in header, invoices)
  companyName          String?   // pre-fills invoice company header
  invoiceCurrency      String    @default("USD")
  invoiceDueDays       Int       @default(30)
  invoiceFooter        String?   // default notes/footer text for new invoices

  // Stripe / subscription
  isPro                Boolean   @default(false)
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique

  @@map("users") // Map model to 'users' table in DB
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("password_reset_tokens")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  meta      Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

model Invoice {
  id             String        @id @default(cuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  
  // Client Info (simplified from mock-db for direct storage)
  clientName     String
  clientEmail    String?
  clientAddress  String?
  clientPhone    String?

  // Invoice Metadata
  invoiceNumber  String
  issueDate      String // Stored as ISO date string "YYYY-MM-DD"
  dueDate        String // Stored as ISO date string "YYYY-MM-DD"
  status         InvoiceStatus
  originalStatus InvoiceStatus? // Used for soft delete restore
  deletedAt      DateTime?     // For soft delete

  // Line Items (JSON type for flexibility)
  lineItems      Json

  // Summary
  subtotal       Float
  taxRate        Float
  taxAmount      Float
  discountRate   Float
  discountAmount Float
  total          Float

  notes          String?
  logo           String?       // base64 data URL

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([userId])
  @@index([userId, status])
  @@index([userId, deletedAt])
  @@map("invoices") // Map model to 'invoices' table in DB
}
